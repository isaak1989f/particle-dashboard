<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vehicle Control</title>

  <script src="https://cdn.jsdelivr.net/npm/particle-api-js@8/dist/particle.min.js"></script>

  <style>
    :root{
      --text:#fff; --muted:rgba(255,255,255,.72); --muted2:rgba(255,255,255,.45);
      --green:#19d35b;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 50% 20%, #1a1a1d 0%, #0b0b0c 45%, #050506 100%);
      display:flex; align-items:center; justify-content:center;
    }

    .phone{
      width:min(420px, 100vw);
      height:min(900px, 100vh);
      aspect-ratio: 9/19.5;
      background: linear-gradient(180deg, #050506 0%, #1a1a1d 25%, #2b2b2f 55%, #4a4a50 100%);
      border-radius: 28px;
      overflow:hidden;
      box-shadow: var(--shadow);
      position:relative;
    }

    .topbar{
      padding: 18px 18px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0));
    }
    .title{font-size: 20px;font-weight: 800;}
    .subtitle{font-size: 12px;color: var(--muted2);margin-top: 2px;}
    .top-left{display:flex;flex-direction:column}
    .btnTop{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08); color:#fff; cursor:pointer;
    }

    .car-area{height: 43%;display:flex;align-items:center;justify-content:center;padding: 8px 20px 0;}
    .car-wrap{
      width:100%;height:100%;display:grid;place-items:center;border-radius:18px;
      background: radial-gradient(800px 300px at 50% 40%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%);
      color: rgba(255,255,255,.55);
      text-align:center;
    }

    .status{
      padding: 4px 22px 0;
      display:flex; align-items:center; justify-content:space-between;
      color: var(--muted); font-size: 16px;
    }
    .status .item{display:flex;align-items:center;gap:10px;min-width: 90px;}
    .status .center{justify-content:center;min-width: 80px;text-transform: lowercase;color: var(--muted2);}

    .controls{
      position:absolute; left:0; right:0; bottom: 56px;
      padding: 0 26px; display:flex; align-items:center; justify-content:space-between; gap:18px;
    }
    .round{
      width: 86px; height: 86px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
      color:#fff; font-size:28px;
    }
    .round:active{transform: scale(.98)}
    .engine-wrap{width:128px;height:128px;border-radius:999px;display:grid;place-items:center;position:relative;cursor:pointer;border:none;background:transparent}
    .engine-ring{
      position:absolute; inset:0; border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.55) 0 52%, rgba(0,0,0,0) 54%),
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.12), rgba(255,255,255,0) 60%),
        conic-gradient(from 120deg, rgba(0,0,0,.0), rgba(255,255,255,.10), rgba(0,0,0,.0));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
    }
    .engine-inner{
      width: 102px; height: 102px; border-radius:999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.10);
      display:grid; place-items:center; position:relative; overflow:hidden;
    }
    .engine-glow{
      position:absolute; inset:-12px;
      background: radial-gradient(circle at 50% 45%, rgba(25,211,91,.65), rgba(25,211,91,0) 60%);
      opacity:.25; transition: opacity .2s ease;
    }
    .engine-on .engine-glow{opacity:1}
    .engine-text{position:relative;text-align:center;font-weight:900;letter-spacing:.5px;line-height:1.05;font-size:14px;}
    .engine-sub{margin-top:6px;font-size:11px;font-weight:800;color:rgba(255,255,255,.55);letter-spacing:.8px;}
    .engine-on .engine-sub{color:rgba(25,211,91,.95)}

    .toast{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: 160px;
      padding:10px 12px; border-radius: 12px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.86);
      font-size: 13px;
      display:none;
      max-width: 90%;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="topbar">
      <div class="top-left">
        <div class="title" id="title">Vehicle</div>
        <div class="subtitle" id="sub">Checking statusâ€¦</div>
      </div>
      <button class="btnTop" id="backBtn">Back</button>
    </div>

    <div class="car-area">
      <div class="car-wrap">
        <div style="font-weight:800; margin-bottom:6px;">(vehicle image area)</div>
        <div style="font-size:12px; color:rgba(255,255,255,.45);">You can drop your van image here later</div>
      </div>
    </div>

    <div class="status">
      <div class="item"><div>ðŸ”‹</div><div id="batText">â€”</div></div>
      <div class="item center"><div id="engineStateText">off</div></div>
      <div class="item" style="justify-content:flex-end"><div>ðŸ“¶</div><div id="sigText">â€”</div></div>
    </div>

    <div class="controls">
      <button class="round" id="unlockBtn" title="Unlock">ðŸ”“</button>

      <button class="engine-wrap" id="engineBtn" aria-label="Engine start stop">
        <div class="engine-ring"></div>
        <div class="engine-inner" id="engineInner">
          <div class="engine-glow"></div>
          <div class="engine-text">
            ENGINE<br/>START<br/>STOP
            <div class="engine-sub" id="engineSub">OFF</div>
          </div>
        </div>
      </button>

      <button class="round" id="lockBtn" title="Lock">ðŸ”’</button>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
  const particle = new Particle();

  const qs = new URLSearchParams(location.search);
  const deviceId = qs.get("deviceId");
  const deviceName = qs.get("name") || "Device";
  const token = sessionStorage.particleToken;

  const titleEl = document.getElementById("title");
  const subEl = document.getElementById("sub");
  const toastEl = document.getElementById("toast");

  const batText = document.getElementById("batText");
  const sigText = document.getElementById("sigText");
  const engineStateText = document.getElementById("engineStateText");
  const engineInner = document.getElementById("engineInner");
  const engineSub = document.getElementById("engineSub");

  let engineOn = false;

  titleEl.textContent = deviceName;

  document.getElementById("backBtn").onclick = () => history.back();

  function toast(msg, ms=2200){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.style.display="none", ms);
  }

  function setEngineUI(on){
    engineOn = !!on;
    engineStateText.textContent = engineOn ? "on" : "off";
    engineSub.textContent = engineOn ? "ON" : "OFF";
    engineInner.classList.toggle("engine-on", engineOn);
  }

  async function refreshStatus(){
    if (!token) { subEl.textContent = "Not logged in"; return; }
    if (!deviceId) { subEl.textContent = "Missing deviceId"; return; }

    try {
      const d = await particle.getDevice({ deviceId, auth: token });
      subEl.textContent = d.body.connected ? "online" : "offline";

      // Optional: if you want, you can show battery/signal from your existing variables:
      // - you have deviceSensorJson, coolant_temp, oil_pressure, engine RPM, J1939Speed, etc.
      // Hereâ€™s an example reading the Json var:
      try {
        const v = await particle.getVariable({ deviceId, name: "deviceSensorJson", auth: token });
        // your string format is like {:temp:123:oilPsi:45:rpm:600:proheatStatus:0:}
        const s = String(v.body.result || "");
        const rpmMatch = s.match(/:rpm:(\d+)/);
        if (rpmMatch) setEngineUI(parseInt(rpmMatch[1],10) >= 400);
      } catch {}

      // You donâ€™t currently have a batt/signal variable in firmware, so these are placeholders:
      batText.textContent = "â€”";
      sigText.textContent = "â€”";

    } catch (e) {
      subEl.textContent = "error";
      toast("Status error. Try going back + re-login.", 2800);
    }
  }

  // ENGINE: call your existing Particle.function "Command" with arg "start"
  document.getElementById("engineBtn").onclick = async () => {
    if (!token) return toast("Not logged in.");
    if (!deviceId) return toast("Missing deviceId.");

    toast("Sending STARTâ€¦");
    try {
      const resp = await particle.callFunction({
        deviceId,
        name: "Command",      // <-- matches your firmware
        argument: "start",    // <-- triggers start branch
        auth: token
      });

      toast("START sent âœ… return_value: " + (resp.body.return_value ?? "â€”"));
      setEngineUI(true);

    } catch (e) {
      toast("START failed: " + (e?.body?.error || e.message || "unknown"), 3200);
    }
  };

  // Optional: wire these too (same function, different args)
  document.getElementById("lockBtn").onclick = () => toast("Lock (wire me if needed)");
  document.getElementById("unlockBtn").onclick = () => toast("Unlock (wire me if needed)");

  refreshStatus();
  setInterval(refreshStatus, 10000);
</script>
</body>
</html>
