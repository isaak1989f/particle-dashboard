<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vehicle Control</title>

  <!-- Particle JS (same library you already use) -->
  <script src="https://cdn.jsdelivr.net/npm/particle-api-js@8/dist/particle.min.js"></script>

  <style>
    :root{
      --text:#fff; --muted:rgba(255,255,255,.72); --muted2:rgba(255,255,255,.45);
      --green:#19d35b;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 50% 20%, #1a1a1d 0%, #0b0b0c 45%, #050506 100%);
      display:flex; align-items:center; justify-content:center;
    }

    .phone{
      width:min(420px, 100vw);
      height:min(900px, 100vh);
      aspect-ratio: 9/19.5;
      background: linear-gradient(180deg, #050506 0%, #1a1a1d 25%, #2b2b2f 55%, #4a4a50 100%);
      border-radius: 28px;
      overflow:hidden;
      box-shadow: var(--shadow);
      position:relative;
    }

    .topbar{
      padding: 30px 18px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0));
    }
    .title{font-size: 20px;font-weight: 800;}
    .subtitle{font-size: 12px;color: var(--muted2);margin-top: 2px;}
    .top-left{display:flex;flex-direction:column}
    .btnTop{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08); color:#fff; cursor:pointer;
    }

    /* Sensor tiles */
    .tiles{
      padding: 12px 18px 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .tile{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .tile .k{font-size:12px;color:rgba(255,255,255,.55);font-weight:700;letter-spacing:.4px}
    .tile .v{font-size:20px;font-weight:900;margin-top:6px}

    .centerRow{
      padding: 10px 18px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.75);
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.5px;
      text-transform: uppercase;
    }
    .pill.online{border-color: rgba(25,211,91,.35); color: rgba(25,211,91,.95)}
    .pill.offline{border-color: rgba(220,53,69,.35); color: rgba(220,53,69,.95)}

    /* CAN status */
    .pill.can-ok {border-color: rgba(25,211,91,.35);color: rgba(25,211,91,.95);}
    .pill.can-off {border-color: rgba(220,53,69,.35);color: rgba(220,53,69,.95);}

    /* Engine status */
    .pill.engine-on {border-color: rgba(25,211,91,.35);color: rgba(25,211,91,.95);}
    .pill.engine-off {border-color: rgba(255,255,255,.25);color: rgba(255,255,255,.75);}

    .controls{
      position:absolute; left:0; right:0; bottom: 200px;
      padding: 0 26px; display:flex; align-items:center; justify-content:space-between; gap:18px;
    }

    .round{
      width: 86px; height: 86px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, opacity .15s ease;
      user-select:none;
      color:#fff; font-size:10px;
    }
    .round:active{transform: scale(.98)}

    /* Pressed + sending animation (for round buttons) */
    .round.pressed{
      transform: scale(0.94);
      background: rgba(25,211,91,.25);
      border-color: rgba(25,211,91,.45);
      box-shadow: 0 4px 10px rgba(0,0,0,.35) inset;
    }
    .round.sending{
      opacity: 0.6;
      pointer-events: none;
    }

    /* Disabled state (offline lock) */
    .disabled-ui{
      opacity: 0.45 !important;
      pointer-events: none !important;
      filter: grayscale(0.25);
    }

    .engine-wrap{width:128px;height:128px;border-radius:999px;display:grid;place-items:center;position:relative;cursor:pointer;border:none;background:transparent}
    .engine-ring{
      position:absolute; inset:0; border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.55) 0 52%, rgba(0,0,0,0) 54%),
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.12), rgba(255,255,255,0) 60%),
        conic-gradient(from 120deg, rgba(0,0,0,.0), rgba(255,255,255,.10), rgba(0,0,0,.0));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
    }

    /* Spinner ring (hidden by default) */
    .engine-spinner{
      position:absolute;
      inset:-6px;
      border-radius:999px;
      border: 3px solid rgba(255,255,255,.10);
      border-top-color: rgba(25,211,91,.90);
      opacity: 0;
      transition: opacity .15s ease;
      pointer-events:none;
      animation: spin 0.9s linear infinite;
    }
    .engine-wrap.cranking .engine-spinner{ opacity: 1; }

    @keyframes spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    .engine-inner{
      width: 102px; height: 102px; border-radius:999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.10);
      display:grid; place-items:center; position:relative; overflow:hidden;
      transition: transform .10s ease, filter .10s ease;
    }
    .engine-glow{
      position:absolute; inset:-12px;
      background: radial-gradient(circle at 50% 45%, rgba(25,211,91,.65), rgba(25,211,91,0) 60%);
      opacity:.25; transition: opacity .2s ease;
    }
    .engine-on .engine-glow{opacity:1}
    .engine-text{position:relative;text-align:center;font-weight:900;letter-spacing:.5px;line-height:1.05;font-size:14px;}
    .engine-sub{margin-top:6px;font-size:11px;font-weight:800;color:rgba(255,255,255,.55);letter-spacing:.8px;}
    .engine-on .engine-sub{color:rgba(25,211,91,.95)}

    /* Engine long-press visual feedback */
    .engine-pressing{
      transform: scale(0.96);
      filter: brightness(1.2);
    }

    /* Toggles section */
    .toggles{
      position:absolute;
      left:0; right:0;
      bottom: 48px;
      padding: 0 18px;
      display:grid;
      gap:10px;
    }
    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 500;
      letter-spacing:.2px;
    }
    .toggleRow input{transform: scale(1.4);}

    .toast{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: 320px;
      padding:10px 12px; border-radius: 12px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.86);
      font-size: 13px;
      display:none;
      max-width: 90%;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="topbar">
      <div class="top-left">
        <div class="title" id="title">Vehicle</div>
        <div class="subtitle" id="sub">Checking status…</div>
      </div>
      <button class="btnTop" id="backBtn">Back</button>
    </div>

    <div class="tiles">
      <div class="tile">
        <div class="k">RPM</div>
        <div class="v" id="rpmEl">--</div>
      </div>
      <div class="tile">
        <div class="k">COOLANT</div>
        <div class="v" id="tempEl">--</div>
      </div>
      <div class="tile">
        <div class="k">OIL PSI</div>
        <div class="v" id="oilEl">--</div>
      </div>
      <div class="tile">
        <div class="k">PRO HEAT</div>
        <div class="v" id="proHeatEl">--</div>
      </div>
    </div>

    <div class="centerRow">
      <div class="pill" id="onlinePill">—</div>
      <div class="pill engine-off" id="enginePill">ENGINE OFF</div>
      <div class="pill" id="canPill">CAN —</div>
    </div>

    <div class="controls">
      <button class="round" id="idleUpBtn">IDLEUP</button>

      <button class="engine-wrap" id="engineBtn" aria-label="Engine start stop">
        <div class="engine-spinner" id="engineSpinner"></div>
        <div class="engine-ring"></div>
        <div class="engine-inner" id="engineInner">
          <div class="engine-glow"></div>
          <div class="engine-text">
            ENGINE<br/>START<br/>STOP
            <div class="engine-sub" id="engineSub">HOLD</div>
          </div>
        </div>
      </button>

      <button class="round" id="refreshBtn">REFRESH</button>
    </div>

    <div class="toast" id="toast"></div>

    <div class="toggles">
      <div class="toggleRow" id="idleUpRow">
        <div>Idle Up</div>
        <input type="checkbox" id="idleUpToggle">
      </div>

      <div class="toggleRow" id="proHeatRow">
        <div>Pro Heat</div>
        <input type="checkbox" id="proHeatToggle">
      </div>
    </div>
  </div>

<script>
  const particle = new Particle();

  const qs = new URLSearchParams(location.search);
  const deviceId = qs.get("deviceId");
  const deviceName = qs.get("name") || "Device";
  const token = sessionStorage.particleToken;

  // UI refs
  const titleEl = document.getElementById("title");
  const subEl = document.getElementById("sub");
  const toastEl = document.getElementById("toast");

  const rpmEl = document.getElementById("rpmEl");
  const tempEl = document.getElementById("tempEl");
  const oilEl = document.getElementById("oilEl");
  const proHeatEl = document.getElementById("proHeatEl");

  const onlinePill = document.getElementById("onlinePill");
  const enginePill = document.getElementById("enginePill");
  const canPill = document.getElementById("canPill");

  const engineBtn = document.getElementById("engineBtn");
  const engineInner = document.getElementById("engineInner");
  const engineSub = document.getElementById("engineSub");

  const idleUpToggle = document.getElementById("idleUpToggle");
  const proHeatToggle = document.getElementById("proHeatToggle");

  const idleUpBtn = document.getElementById("idleUpBtn");
  const refreshBtn = document.getElementById("refreshBtn");

  // state
  let currentRPM = 0;
  let longPressMs = 800;
  let pressTimer = null;
  let lastProHeat = null;
  let isConnected = false;
  let isCranking = false;

  titleEl.textContent = deviceName;
  document.getElementById("backBtn").onclick = () => history.back();

  function toast(msg, ms=2200){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.style.display="none", ms);
  }

  // Haptic vibration (mobile)
  function haptic(ms=25){
    if (navigator.vibrate) navigator.vibrate(ms);
  }

  // Press helpers for round buttons
  function pressBtn(btn) {
    btn.classList.add("pressed", "sending");
  }
  function releaseBtn(btn, delay = 600) {
    setTimeout(() => btn.classList.remove("pressed", "sending"), delay);
  }

  // Lock UI when offline
  function setControlsEnabled(enabled){
    const els = [idleUpBtn, refreshBtn, engineBtn, idleUpToggle, proHeatToggle];
    els.forEach(el => {
      if (!el) return;
      el.classList.toggle("disabled-ui", !enabled);
      if (el.tagName === "INPUT" || el.tagName === "BUTTON") {
        el.disabled = !enabled;
      }
      // engineBtn is a button; ok to disable
    });
  }

  function setEngineUI(rpm){
    const on = (rpm > 0);

    engineInner.classList.toggle("engine-on", on);

    enginePill.textContent = on ? "ENGINE ON" : "ENGINE OFF";
    engineSub.textContent = isCranking ? "CRANKING" : "HOLD";

    enginePill.classList.toggle("engine-on", on);
    enginePill.classList.toggle("engine-off", !on);
  }

  function setCanUI(canOk){
    canPill.textContent = canOk ? "CAN OK" : "CAN OFF";
    canPill.classList.toggle("can-ok", !!canOk);
    canPill.classList.toggle("can-off", !canOk);
  }

  function setOnlineUI(connected){
    onlinePill.textContent = connected ? "ONLINE" : "OFFLINE";
    onlinePill.classList.toggle("online", !!connected);
    onlinePill.classList.toggle("offline", !connected);
  }

  function setCrankingUI(on){
    isCranking = on;
    engineBtn.classList.toggle("cranking", on);
    setEngineUI(currentRPM);
  }

  // Firmware format: {:temp:185:oilPsi:42:rpm:650:proheatStatus:1:}
  function parseSensorJson(str) {
    const out = {};
    if (!str) return out;

    const cleaned = String(str).replace(/[{}]/g, "");
    const parts = cleaned.split(":").filter(p => p.length);

    for (let i = 0; i < parts.length - 1; i += 2) {
      const key = parts[i];
      const val = Number(parts[i + 1]);
      if (!Number.isNaN(val)) out[key] = val;
    }
    return out;
  }

  async function refreshStatus(){
    if (!token) { subEl.textContent = "Not logged in"; setControlsEnabled(false); return; }
    if (!deviceId) { subEl.textContent = "Missing deviceId"; setControlsEnabled(false); return; }

    try {
      const dev = await particle.getDevice({ deviceId, auth: token });
      isConnected = !!dev.body.connected;

      subEl.textContent = isConnected ? "Connected" : "Offline";
      setOnlineUI(isConnected);
      setControlsEnabled(isConnected);

      // CANstate
      if (isConnected) {
        try {
          const can = await particle.getVariable({ deviceId, name: "CANstate", auth: token });
          const canVal = Number(can.body.result);
          if (!Number.isNaN(canVal)) setCanUI(canVal === 1);
          else {
            canPill.textContent = "CAN —";
            canPill.classList.remove("can-ok", "can-off");
          }
        } catch {
          canPill.textContent = "CAN —";
          canPill.classList.remove("can-ok", "can-off");
        }
      } else {
        canPill.textContent = "CAN —";
        canPill.classList.remove("can-ok", "can-off");
      }

      // Sensor JSON (only if connected)
      if (isConnected) {
        const v = await particle.getVariable({ deviceId, name: "deviceSensorJson", auth: token });
        const data = parseSensorJson(v.body.result);

        currentRPM = data.rpm ?? 0;

        rpmEl.textContent = `${currentRPM} rpm`;
        tempEl.textContent = (data.temp != null) ? `${data.temp} °F` : "--";
        oilEl.textContent = (data.oilPsi != null) ? `${data.oilPsi} psi` : "--";

        const ph = (data.proheatStatus != null) ? Number(data.proheatStatus) : null;
        if (ph === 1) proHeatEl.textContent = "ON";
        else if (ph === 0) proHeatEl.textContent = "OFF";
        else proHeatEl.textContent = "--";

        setEngineUI(currentRPM);

        if (ph !== null && ph !== lastProHeat) {
          proHeatToggle.checked = (ph === 1);
          lastProHeat = ph;
        }
      } else {
        rpmEl.textContent = "--";
        tempEl.textContent = "--";
        oilEl.textContent = "--";
        proHeatEl.textContent = "--";
        currentRPM = 0;
        setEngineUI(0);
      }

    } catch (e) {
      subEl.textContent = "Status error";
      setControlsEnabled(false);
    }
  }

  async function sendCommand(cmd, opts = {}) {
    const { showToast = true, haptics = true } = opts;

    if (!token) { toast("Not logged in."); return false; }
    if (!deviceId) { toast("Missing deviceId."); return false; }
    if (!isConnected) { toast("Device is offline."); return false; }

    if (haptics) haptic(20);
    if (showToast) toast(`Sending ${cmd}…`);

    try {
      const resp = await particle.callFunction({
        deviceId,
        name: "Command",
        argument: cmd,
        auth: token
      });

      if (haptics) haptic(35);
      if (showToast) toast(`${cmd} sent ✅ (rv:${resp.body.return_value ?? "—"})`);

      setTimeout(refreshStatus, 1200);
      return true;
    } catch (e) {
      if (haptics) haptic([20, 40, 20]);
      toast(`${cmd} failed: ${e?.body?.error || e.message || "unknown"}`, 3200);
      return false;
    }
  }

  // Engine long press: start if rpm==0 else stop
  function startPress(e) {
    e.preventDefault();
    if (!isConnected) return;

    haptic(10);
    engineInner.classList.add("engine-pressing");

    clearTimeout(pressTimer);
    pressTimer = setTimeout(async () => {
      const cmd = (currentRPM > 0) ? "stop" : "start";

      // show spinner during start/stop attempt (especially start)
      setCrankingUI(true);

      await sendCommand(cmd, { showToast: true, haptics: true });

      // turn spinner off after a short delay (status refresh will also update)
      setTimeout(() => setCrankingUI(false), 2200);

      engineInner.classList.remove("engine-pressing");
    }, longPressMs);
  }

  function cancelPress() {
    clearTimeout(pressTimer);
    engineInner.classList.remove("engine-pressing");
  }

  engineBtn.addEventListener("mousedown", startPress);
  engineBtn.addEventListener("touchstart", startPress, { passive: false });

  engineBtn.addEventListener("mouseup", cancelPress);
  engineBtn.addEventListener("mouseleave", cancelPress);
  engineBtn.addEventListener("touchend", cancelPress);

  // Toggles
  idleUpToggle.onchange = async () => {
    if (!isConnected) { idleUpToggle.checked = false; return; }
    if (idleUpToggle.checked) {
      await sendCommand("idleUp");
      setTimeout(()=> idleUpToggle.checked = false, 250);
    }
  };

  proHeatToggle.onchange = async () => {
    if (!isConnected) { proHeatToggle.checked = !!lastProHeat; return; }
    await sendCommand(proHeatToggle.checked ? "proHeattrue" : "proHeatfalse");
  };

  // Round buttons with pressed animation + disable while sending
  idleUpBtn.onclick = async () => {
    if (!isConnected) return toast("Device is offline.");
    pressBtn(idleUpBtn);
    await sendCommand("idleUp");
    releaseBtn(idleUpBtn);
  };

  refreshBtn.onclick = async () => {
    if (!isConnected) return toast("Device is offline.");
    pressBtn(refreshBtn);
    await sendCommand("ingOn");
    releaseBtn(refreshBtn);
  };

  // Start
  setControlsEnabled(false);
  refreshStatus();
  setInterval(refreshStatus, 5000);
</script>
</body>
</html>
