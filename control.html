<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vehicle Control</title>

  <!-- Particle JS (same library you already use) -->
  <script src="https://cdn.jsdelivr.net/npm/particle-api-js@8/dist/particle.min.js"></script>

  <style>
    :root{
      --text:#fff; --muted:rgba(255,255,255,.72); --muted2:rgba(255,255,255,.45);
      --green:#19d35b;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 50% 20%, #1a1a1d 0%, #0b0b0c 45%, #050506 100%);
      display:flex; align-items:center; justify-content:center;
    }

    .phone{
      width:min(420px, 100vw);
      height:min(900px, 100vh);
      aspect-ratio: 9/19.5;
      background: linear-gradient(180deg, #050506 0%, #1a1a1d 25%, #2b2b2f 55%, #4a4a50 100%);
      border-radius: 28px;
      overflow:hidden;
      box-shadow: var(--shadow);
      position:relative;
    }

    .topbar{
      padding: 30px 18px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0));
    }
    .title{font-size: 20px;font-weight: 800;}
    .subtitle{font-size: 12px;color: var(--muted2);margin-top: 2px;}
    .top-left{display:flex;flex-direction:column}
    .btnTop{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08); color:#fff; cursor:pointer;
    }

    .car-area{height: 40%;display:flex;align-items:center;justify-content:center;padding: 8px 20px 0;}
    .car-wrap{
      width:100%;height:100%;display:grid;place-items:center;border-radius:18px;
      background: radial-gradient(800px 300px at 50% 40%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%);
      color: rgba(255,255,255,.55);
      text-align:center;
    }

    /* Sensor tiles */
    .tiles{
      padding: 12px 18px 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .tile{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .tile .k{font-size:12px;color:rgba(255,255,255,.55);font-weight:700;letter-spacing:.4px}
    .tile .v{font-size:20px;font-weight:900;margin-top:6px}

    .centerRow{
      padding: 10px 18px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.75);
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.5px;
      text-transform: uppercase;
    }
    .pill.online{border-color: rgba(25,211,91,.35); color: rgba(25,211,91,.95)}
    .pill.offline{border-color: rgba(220,53,69,.35); color: rgba(220,53,69,.95)}
     /* CAN status */
    .pill.can-ok {border-color: rgba(25,211,91,.35);color: rgba(25,211,91,.95);}
    .pill.can-off {border-color: rgba(220,53,69,.35);color: rgba(220,53,69,.95);}
    /* Engine status */
    .pill.engine-on {border-color: rgba(25,211,91,.35);color: rgba(25,211,91,.95);}
    .pill.engine-off {border-color: rgba(255,255,255,.25);color: rgba(255,255,255,.75);}

    .controls{
      position:absolute; left:0; right:0; bottom: 200px;
      padding: 0 26px; display:flex; align-items:center; justify-content:space-between; gap:18px;
    }
    .round{
      width: 86px; height: 86px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
      color:#fff; font-size:10px;
    }
    .round:active{transform: scale(.98)}

    .engine-wrap{width:128px;height:128px;border-radius:999px;display:grid;place-items:center;position:relative;cursor:pointer;border:none;background:transparent}
    .engine-ring{
      position:absolute; inset:0; border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.55) 0 52%, rgba(0,0,0,0) 54%),
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.12), rgba(255,255,255,0) 60%),
        conic-gradient(from 120deg, rgba(0,0,0,.0), rgba(255,255,255,.10), rgba(0,0,0,.0));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
    }
    .engine-inner{
      width: 102px; height: 102px; border-radius:999px;
      background: rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.10);
      display:grid; place-items:center; position:relative; overflow:hidden;
    }
    .engine-glow{
      position:absolute; inset:-12px;
      background: radial-gradient(circle at 50% 45%, rgba(25,211,91,.65), rgba(25,211,91,0) 60%);
      opacity:.25; transition: opacity .2s ease;
    }
    .engine-on .engine-glow{opacity:1}
    .engine-text{position:relative;text-align:center;font-weight:900;letter-spacing:.5px;line-height:1.05;font-size:14px;}
    .engine-sub{margin-top:6px;font-size:11px;font-weight:800;color:rgba(255,255,255,.55);letter-spacing:.8px;}
    .engine-on .engine-sub{color:rgba(25,211,91,.95)}

    /* Toggles section */
    .toggles{
      position:absolute;
      left:0; right:0;
      bottom: 48px;
      padding: 0 18px;
      display:grid;
      gap:10px;
    }
    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 500;
      letter-spacing:.2px;
    }
    .toggleRow small{display:block;font-weight:700;color:rgba(255,255,255,.55);letter-spacing:0;margin-top:3px}
    .toggleRow input{transform: scale(1.4);}

    .toast{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: 320px;
      padding:10px 12px; border-radius: 12px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.86);
      font-size: 13px;
      display:none;
      max-width: 90%;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="topbar">
      <div class="top-left">
        <div class="title" id="title">Vehicle</div>
        <div class="subtitle" id="sub">Checking status…</div>
      </div>
      <button class="btnTop" id="backBtn">Back</button>
    </div>

    <div class="tiles">
      <div class="tile">
        <div class="k">RPM</div>
        <div class="v" id="rpmEl">--</div>
      </div>
      <div class="tile">
        <div class="k">COOLANT</div>
        <div class="v" id="tempEl">--</div>
      </div>
      <div class="tile">
        <div class="k">OIL PSI</div>
        <div class="v" id="oilEl">--</div>
      </div>
      <div class="tile">
        <div class="k">PRO HEAT</div>
        <div class="v" id="proHeatEl">--</div>
      </div>
    </div>
    

    <div class="centerRow">
      <div class="pill" id="onlinePill">—</div>
      <div class="pill" id="enginePill">ENGINE OFF</div>
      <div class="pill" id="canPill">CAN —</div>
      
    </div>

    <div class="controls">
      <button class="round" id="unlockBtn" title="Unlock">UNLOCK</button>
       
      <button class="engine-wrap" id="engineBtn" aria-label="Engine start stop">
        <div class="engine-ring"></div>
        <div class="engine-inner" id="engineInner">
          <div class="engine-glow"></div>
          <div class="engine-text">
            ENGINE<br/>START<br/>STOP
            <div class="engine-sub" id="engineSub">HOLD</div>
          </div>
        </div>
      </button>

      <button class="round" id="lockBtn" title="Lock">LOCK</button>
    </div>

    <div class="toast" id="toast"></div>

    <div class="toggles">
      <div class="toggleRow">
        <div>
          Idle Up
        </div>
        <input type="checkbox" id="idleUpToggle">
      </div>

      <div class="toggleRow">
        <div>
          Pro Heat
        </div>
        <input type="checkbox" id="proHeatToggle">
      </div>
    </div>
  </div>

<script>
  // --- Particle + routing
  const particle = new Particle();

  const qs = new URLSearchParams(location.search);
  const deviceId = qs.get("deviceId");
  const deviceName = qs.get("name") || "Device";
  const token = sessionStorage.particleToken; // keeps your current system

  // --- UI refs
  const titleEl = document.getElementById("title");
  const subEl = document.getElementById("sub");
  const toastEl = document.getElementById("toast");

  const rpmEl = document.getElementById("rpmEl");
  const tempEl = document.getElementById("tempEl");
  const oilEl = document.getElementById("oilEl");
  const proHeatEl = document.getElementById("proHeatEl");

  const onlinePill = document.getElementById("onlinePill");
  const enginePill = document.getElementById("enginePill");
  const canPill = document.getElementById("canPill");

  const engineBtn = document.getElementById("engineBtn");
  const engineInner = document.getElementById("engineInner");
  const engineSub = document.getElementById("engineSub");

  const idleUpToggle = document.getElementById("idleUpToggle");
  const proHeatToggle = document.getElementById("proHeatToggle");

  // --- state
  let currentRPM = 0;
  let longPressMs = 800;
  let pressTimer = null;
  let lastProHeat = null;

  titleEl.textContent = deviceName;
  document.getElementById("backBtn").onclick = () => history.back();

  function toast(msg, ms=2200){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.style.display="none", ms);
  }

  function setEngineUI(rpm){
  const on = (rpm > 0);

  // Glow animation
  engineInner.classList.toggle("engine-on", on);

  // Text
  enginePill.textContent = on ? "ENGINE ON" : "ENGINE OFF";
  engineSub.textContent = "HOLD";

  // Pill color
  enginePill.classList.toggle("engine-on", on);
  enginePill.classList.toggle("engine-off", !on);
}

  function setCanUI(canOk){
  canPill.textContent = canOk ? "CAN OK" : "CAN OFF";
  canPill.classList.toggle("can-ok", !!canOk);
  canPill.classList.toggle("can-off", !canOk);
}

  function setOnlineUI(connected){
    onlinePill.textContent = connected ? "ONLINE" : "OFFLINE";
    onlinePill.classList.toggle("online", !!connected);
    onlinePill.classList.toggle("offline", !connected);
  }

  // Your firmware format: {:temp:185:oilPsi:42:rpm:650:proheatStatus:1:}
  function parseSensorJson(str) {
    const out = {};
    if (!str) return out;

    const cleaned = String(str).replace(/[{}]/g, "");  // ":temp:185:oilPsi:..."
    const parts = cleaned.split(":").filter(p => p.length); // remove empty items

    // parts example: ["temp","185","oilPsi","42","rpm","650","proheatStatus","1"]
    for (let i = 0; i < parts.length - 1; i += 2) {
      const key = parts[i];
      const val = Number(parts[i + 1]);
      if (!Number.isNaN(val)) out[key] = val;
    }
    return out;
  }

  async function refreshStatus(){
    if (!token) { subEl.textContent = "Not logged in"; return; }
    if (!deviceId) { subEl.textContent = "Missing deviceId"; return; }

    try {
      // Device connectivity
      const dev = await particle.getDevice({ deviceId, auth: token });
      const connected = !!dev.body.connected;
      subEl.textContent = connected ? "Connected" : "Offline";
      setOnlineUI(connected);

// CANstate (optional, you expose it)
     let canOk = null;

try {
  const can = await particle.getVariable({
    deviceId,
    name: "CANstate",
    auth: token
  });

  const raw = can?.body?.result;
  const canVal = Number(raw);

  if (!Number.isNaN(canVal)) {
    canOk = (canVal === 1);
  }
} catch (e) {
  console.warn("CANstate unavailable:", e?.body?.error || e.message);
}

// Apply UI state
if (canOk === true) {
  setCanUI(true);
} else if (canOk === false) {
  setCanUI(false);
} else {
  canPill.textContent = "CAN —";
  canPill.classList.remove("can-ok", "can-off");
}




      // Sensor JSON
      const v = await particle.getVariable({ deviceId, name: "deviceSensorJson", auth: token });
      const data = parseSensorJson(v.body.result);

      // Update fields
      currentRPM = data.rpm ?? 0;

      rpmEl.textContent = `${currentRPM} rpm`;
      tempEl.textContent = (data.temp != null) ? `${data.temp} °F` : "--";
      oilEl.textContent = (data.oilPsi != null) ? `${data.oilPsi} psi` : "--";

      const ph = (data.proheatStatus != null) ? Number(data.proheatStatus) : null;
      if (ph === 1) proHeatEl.textContent = "ON";
      else if (ph === 0) proHeatEl.textContent = "OFF";
      else proHeatEl.textContent = "--";

      setEngineUI(currentRPM);

      // Keep ProHeat toggle synced to device (but avoid fighting user)
      if (ph !== null && ph !== lastProHeat) {
        proHeatToggle.checked = (ph === 1);
        lastProHeat = ph;
      }

    } catch (e) {
      subEl.textContent = "Status error";
      // don’t spam toast every interval; show only once if needed
      // toast("Status error. Go back + re-login if needed.", 3000);
    }
  }

  async function sendCommand(cmd) {
    if (!token) return toast("Not logged in.");
    if (!deviceId) return toast("Missing deviceId.");

    toast(`Sending ${cmd}…`);
    try {
      const resp = await particle.callFunction({
        deviceId,
        name: "Command",     // matches your firmware
        argument: cmd,
        auth: token
      });
      toast(`${cmd} sent ✅ (rv:${resp.body.return_value ?? "—"})`);
      // refresh quickly after sending
      setTimeout(refreshStatus, 1200);
    } catch (e) {
      toast(`${cmd} failed: ${e?.body?.error || e.message || "unknown"}`, 3200);
    }
  }

  // --- LONG PRESS Engine: start if rpm==0, stop if rpm>0
  function startPress(e) {
    e.preventDefault();
    clearTimeout(pressTimer);
    pressTimer = setTimeout(async () => {
      const cmd = (currentRPM > 0) ? "stop" : "start";
      await sendCommand(cmd);
    }, longPressMs);
  }

  function cancelPress() {
    clearTimeout(pressTimer);
  }

  engineBtn.addEventListener("mousedown", startPress);
  engineBtn.addEventListener("touchstart", startPress, { passive: false });

  engineBtn.addEventListener("mouseup", cancelPress);
  engineBtn.addEventListener("mouseleave", cancelPress);
  engineBtn.addEventListener("touchend", cancelPress);

  // --- Toggles
  idleUpToggle.onchange = () => {
    if (idleUpToggle.checked) {
      sendCommand("idleUp");
      // auto-reset switch to off (since idleUp is an action, not a state)
      setTimeout(()=> idleUpToggle.checked = false, 300);
    }
  };

  proHeatToggle.onchange = () => {
    sendCommand(proHeatToggle.checked ? "proHeattrue" : "proHeatfalse");
    // device will report proheatStatus; refresh will sync UI
  };

  // Optional placeholders for lock/unlock (only if your firmware supports it later)
  document.getElementById("lockBtn").onclick = () => toast("Lock (not wired yet)");
  document.getElementById("unlockBtn").onclick = () => toast("Unlock (not wired yet)");

  // Start
  refreshStatus();
  setInterval(refreshStatus, 5000);
</script>
</body>
</html>
